# FaceRoster 修正アクションプラン

## 🎯 目標
現在動作している基本機能を維持しながら、データの永続化（保存）機能を追加する

## 📋 推奨アプローチ：段階的な修正

### Phase 1: 現在のバグ修正（1-2時間）
**目的**: エラーを解消して基本機能を安定させる

#### 1.1 CORS問題の修正
- [ ] `FaceRosterContext.tsx`の`createRosterFromRegions`で画像作成時に`crossOrigin`属性を追加
- [ ] エラーが解消されることを確認

#### 1.2 一時的なエラー回避
- [ ] `updatePersonDetails`のエラーチェックを調整
- [ ] `currentRosterDocId`がnullの場合は、ローカル更新のみ行う
- [ ] エラーメッセージを「保存するにはRosterを先に保存してください」に変更

#### 📝 1.3 ドキュメント更新
- [ ] `progress.md`を作成/更新：現在の問題点と解決状況を記録
- [ ] `KNOWN_ISSUES.md`を更新：CORS問題と回避策を文書化

### Phase 2: 自動保存機能の実装（2-3時間）
**目的**: ユーザーが意識せずにデータが保存される仕組みを作る

#### 2.1 createRosterFromRegionsの拡張
```typescript
// 以下の処理を追加
1. Roster作成時に自動的にFirestoreに保存
2. currentRosterDocIdを設定
3. 各人物データも同時に保存
```

- [ ] Rosterドキュメントの自動作成
- [ ] 人物データの一括保存
- [ ] 顔画像のStorage保存
- [ ] 保存完了通知の表示

#### 2.2 保存フローの実装
- [ ] ローディング表示の追加
- [ ] エラーハンドリングの強化
- [ ] 保存状態のUI表示（「保存済み」「未保存」など）

#### 📝 2.3 ドキュメント更新
- [ ] `ARCHITECTURE.md`を更新：自動保存の仕組みを設計文書に追加
- [ ] `src/contexts/FaceRosterContext.tsx`にJSDocコメントを追加：新しいメソッドの説明
- [ ] `progress.md`を更新：保存機能の実装状況を記録

### Phase 3: UI/UXの改善（1-2時間）
**目的**: ユーザーが保存状態を理解できるようにする

#### 3.1 保存状態インジケーター
- [ ] ヘッダーに保存状態を表示
- [ ] 未保存の変更がある場合の警告
- [ ] 自動保存中の表示

#### 3.2 Roster名の入力
- [ ] Roster作成時に名前入力ダイアログ
- [ ] デフォルト名の自動生成（例：「Roster_2024-01-15」）

#### 📝 3.3 ドキュメント更新
- [ ] `USER_GUIDE.md`を作成：新しい保存機能の使い方を説明
- [ ] `README.md`を更新：主要機能として自動保存を追加

### Phase 4: 既存機能との統合（1時間）
**目的**: 全体的な機能の整合性を確保

#### 4.1 読み込み機能の確認
- [ ] 保存したRosterが正しく読み込めることを確認
- [ ] 編集・更新が正常に動作することを確認

#### 4.2 削除機能の確認
- [ ] Roster削除時に関連データも削除されることを確認

#### 📝 4.3 最終ドキュメント更新
- [ ] `CHANGELOG.md`を作成：実装した変更の履歴を記録
- [ ] `TODO.md`を更新：完了したタスクをチェック、次の課題を追加
- [ ] `CLAUDE.md`を更新：新しいアーキテクチャの変更を反映

## 🔄 実装順序の推奨

### 今すぐ実装（最優先）
1. **CORS修正**（30分）
   - 最小限の修正で現在の機能を動作させる
   
2. **エラーメッセージ改善**（30分）
   - ユーザーが混乱しないようにする

### 次に実装
3. **自動保存の基本実装**（2時間）
   - `createRosterFromRegions`でFirestore保存
   - 最低限の動作を確保

### 余裕があれば実装
4. **UI改善**（1-2時間）
   - 保存状態の表示
   - より良いユーザー体験

## 📚 ドキュメント管理の重要性

### なぜドキュメント更新が重要か
1. **知識の継承**: あなたや他の開発者が後で理解できる
2. **進捗の可視化**: 何が完了して何が残っているか明確
3. **問題の記録**: 同じ問題を繰り返さない
4. **AIとの連携**: Claude/Agentが現状を正確に把握できる

### 推奨ドキュメント構成
```
docs/
├── progress.md         # 現在の進捗と課題
├── KNOWN_ISSUES.md    # 既知の問題と回避策
├── ARCHITECTURE.md    # システム設計の詳細
├── USER_GUIDE.md      # ユーザー向け使用方法
├── CHANGELOG.md       # 変更履歴
└── TODO.md           # 残タスクリスト
```

### シンプルに始める
- 完璧を求めず、まず動作することを優先
- 複雑な機能は後回し

### 既存コードを活用
- `loadRosterForEditing`の逆の処理として実装
- 既存の型定義やメソッドを再利用

### テストしながら進める
- 各ステップで動作確認
- バグが出たら即修正

## 🚫 避けるべきこと

1. **大規模なリファクタリング**
   - 現在動いている部分は触らない
   - 必要最小限の変更に留める

2. **過度な最適化**
   - まず動作させる
   - パフォーマンスは後で考える

3. **複雑な状態管理**
   - シンプルな自動保存で十分
   - 複雑なオプションは不要

## ✅ 成功の基準

1. 画像アップロード → 顔選択 → Roster作成が**エラーなく**動作
2. 作成したRosterが**自動的に保存**される
3. 保存したRosterを**後で読み込める**
4. 人物情報の編集が**正常に保存**される

## 📝 実装メモ

### 必要な情報
- Firebase プロジェクトID: 既存の設定を使用
- Storage パス: `/users/{userId}/rosters/{rosterId}/`
- Firestore構造: 既存の型定義に従う

### 参考にすべきコード
- `loadRosterForEditing` - 読み込み処理の逆を実装
- `deleteRoster` - データ構造の理解
- 既存の型定義 - データの整合性維持

---

このプランに従って段階的に実装することで、確実に動作する保存機能を追加できます。まずはPhase 1から始めて、動作を確認しながら進めることをお勧めします。
