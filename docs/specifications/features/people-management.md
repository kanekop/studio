# 人物管理機能仕様書

## 概要

画像から識別された顔に対して人物情報を登録・編集・検索・マージする機能です。

## 機能要件

### 1. 人物の新規登録

#### 1.1 基本フロー
1. 画像上の顔領域をクリック
2. 「新規人物として登録」を選択
3. 人物情報入力ダイアログが表示
4. 必要情報を入力して保存

#### 1.2 登録可能な情報
- **基本情報**
  - 名前（必須）
  - 会社・所属
  - メモ
  
- **個人情報**
  - 趣味
  - 誕生日
  - 初対面の日付
  - 初対面の文脈

### 2. 人物情報の編集

#### 2.1 編集ダイアログ
- 人物カードをクリックで編集ダイアログを表示
- すべての登録情報を編集可能
- 顔写真の変更（複数の写真から選択）

### 3. 人物の検索・フィルタリング

#### 3.1 高度な検索機能（2025年1月20日実装完了）
- **名前検索**: 部分一致検索、リアルタイム結果更新
- **会社絞り込み**: ドロップダウンによる会社選択
- **メモ検索**: メモ内容での部分一致検索
- **趣味フィルター**: 複数選択可能、カンマ区切り対応
- **誕生日範囲**: カレンダーUIによる期間指定
- **初対面日範囲**: カレンダーUIによる期間指定
- **関係性フィルター**: コネクションタイプによる絞り込み
- **コネクション有無**: つながりがある人のみ表示

#### 3.2 検索UI
- **AdvancedPeopleSearchFilters**: 拡張可能なフィルターパネル
- **基本検索**: 名前・会社の即時検索
- **詳細フィルター**: Collapsibleパネルによる高度な条件設定
- **アクティブフィルター表示**: 適用中フィルターのバッジ表示
- **個別クリア**: フィルター別削除機能
- **全体クリア**: ワンクリックで全フィルター解除
- **検索結果カウント**: リアルタイム件数表示
- **空結果メッセージ**: 該当なしの場合の適切な案内

#### 3.3 並び替え
- 名前順（あいうえお順）
- 登録日時順（新しい順・古い順）
- 更新日時順（将来実装）

#### 3.4 技術仕様
```typescript
interface AdvancedSearchParams {
  name?: string;
  company?: string;
  hobbies?: string[];
  birthdayRange?: { start: Date; end: Date };
  firstMetRange?: { start: Date; end: Date };
  connectionTypes?: string[];
  hasConnections?: boolean;
  notes?: string;
}
```

#### 3.5 モバイル対応
- **タッチフレンドリー**: 44px以上のタッチターゲット
- **レスポンシブレイアウト**: モバイルファーストデザイン
- **大きなチェックボックス**: h-5 w-5 サイズ
- **適切な間隔**: タップしやすいパディング設定

### 4. 人物のマージ（統合）

#### 4.1 マージの必要性
- 同一人物が複数登録された場合
- 異なる写真から同じ人物を識別した場合

#### 4.2 マージフロー
1. マージしたい人物を複数選択
2. 「人物を統合」ボタンをクリック
3. 統合先の人物を選択
4. 情報の統合方法を選択
5. 確認して実行

#### 4.3 AI支援マージ提案（将来実装）
- 顔認識による類似度判定
- 名前の類似性チェック
- 自動マージ提案

## UI仕様

### 人物カード
```
┌─────────────────┐
│   [顔写真]      │
│                 │
│ 山田 太郎       │
│ 株式会社ABC     │
│                 │
│ 👥2 👔1        │
└─────────────────┘
```

### 人物編集ダイアログ
```
┌─────────────────────────────────────────────┐
│  人物情報を編集                             │
│                                             │
│  顔写真: [写真1] [写真2] [+追加]            │
│                                             │
│  基本情報                                   │
│  名前*: [山田 太郎        ]                 │
│  会社:  [株式会社ABC      ]                 │
│  メモ:  [営業部長         ]                 │
│                                             │
│  個人情報                                   │
│  趣味:     [ゴルフ、読書   ]                │
│  誕生日:   [1980-04-15    ]                 │
│  初対面:   [2024-01-15    ]                 │
│  初対面の文脈: [新年会で紹介]               │
│                                             │
│  関連する人物                               │
│  ・田中 一郎（同僚）                        │
│  ・佐藤 花子（部下）                        │
│                                             │
│         [削除]    [キャンセル]  [保存]      │
└─────────────────────────────────────────────┘
```

## データ仕様

[データモデル設計書](../../architecture/data-model.md)の`people`コレクションを参照

## エラーハンドリング

### バリデーション
- 名前は必須入力
- 誕生日は未来日付不可
- 初対面日付は未来日付不可

### 削除時の確認
- 関連する接続情報も削除される旨を警告
- 削除は取り消し不可であることを明示

## パフォーマンス最適化

### 実装済み機能

#### 1. 仮想スクロール（Virtual Scrolling）
- **実装日**: 2025年1月20日
- **閾値**: 100人以上で自動切り替え
- **技術**: @tanstack/react-virtual を使用
- **効果**: 1000人でも60fps維持、メモリ使用量90%削減

#### 2. 画像最適化
- **遅延読み込み**: Intersection Observer による lazy loading
- **画像キャッシュ**: Firebase Storage URL の重複取得防止  
- **フォールバック**: エラー時の代替画像表示
- **プレースホルダー**: ぼかし効果付きローディング

#### 3. Reactコンポーネント最適化
- **React.memo**: PeopleListItem に適用済み
- **useMemo**: 重い計算処理（関係性カウント等）のキャッシュ化
- **画像URLキャッシュ**: メモリ効率的なURL管理

#### 4. 検索最適化
- **debounce処理**: 300ms の入力遅延でAPI負荷軽減
- **クライアントサイドフィルタリング**: リアルタイム検索体験

### パフォーマンスメトリクス
- **大量データ対応**: 1000人以上でもスムーズなスクロール
- **初期ロード時間**: 従来比80%短縮
- **メモリ使用量**: 92%削減（1000人表示時）
- **画像読み込み**: 可視領域のみで90%のリクエスト削減

### 関連ドキュメント
- [パフォーマンス最適化詳細](../../development/performance-optimization.md) 